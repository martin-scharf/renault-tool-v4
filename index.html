<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Renault V4 — Teile-Zentrale</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
  --bg: #0c0f14;
  --surface: #141820;
  --surface2: #1a1f2a;
  --border: #252b38;
  --text: #e2e6ed;
  --text2: #8891a4;
  --accent: #f5c518;
  --accent2: #e8b800;
  --green: #34d399;
  --red: #f87171;
  --orange: #fb923c;
  --blue: #60a5fa;
  --purple: #a78bfa;
  --radius: 10px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
code, .mono { font-family:'JetBrains Mono',monospace; }

/* AUTH */
#auth-screen { display:flex; align-items:center; justify-content:center; min-height:100vh; }
#auth-box { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:48px; width:380px; text-align:center; }
#auth-box h1 { font-size:22px; font-weight:700; margin-bottom:6px; letter-spacing:-0.5px; }
#auth-box .sub { color:var(--text2); font-size:14px; margin-bottom:28px; }
#auth-box input { width:100%; padding:12px 16px; background:var(--bg); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:14px; margin-bottom:12px; font-family:inherit; }
#auth-box input:focus { outline:none; border-color:var(--accent); }
#auth-box button { width:100%; padding:12px; background:var(--accent); color:#000; border:none; border-radius:8px; font-weight:700; font-size:14px; cursor:pointer; font-family:inherit; }
#auth-box button:hover { background:var(--accent2); }
.auth-err { color:var(--red); font-size:13px; margin-top:8px; display:none; }

/* LAYOUT */
#app { display:none; }
header { background:var(--surface); border-bottom:1px solid var(--border); padding:0 32px; height:56px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; }
header h1 { font-size:17px; font-weight:700; letter-spacing:-0.5px; }
header h1 span { color:var(--accent); }
header .user { color:var(--text2); font-size:13px; }

.tabs { display:flex; gap:0; background:var(--surface); border-bottom:1px solid var(--border); padding:0 32px; }
.tab { padding:12px 24px; font-size:13px; font-weight:500; color:var(--text2); cursor:pointer; border-bottom:2px solid transparent; transition:all .2s; }
.tab:hover { color:var(--text); }
.tab.active { color:var(--accent); border-color:var(--accent); }

main { max-width:1400px; margin:0 auto; padding:28px 32px; }

/* CARDS */
.grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin-bottom:28px; }
.card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:24px; }
.card h3 { font-size:13px; font-weight:500; color:var(--text2); text-transform:uppercase; letter-spacing:1px; margin-bottom:12px; }
.card .num { font-size:32px; font-weight:700; letter-spacing:-1px; }
.card .num.accent { color:var(--accent); }
.card .num.green { color:var(--green); }
.card .num.blue { color:var(--blue); }
.card .detail { font-size:12px; color:var(--text2); margin-top:6px; }

/* UPLOAD ZONE */
.upload-section { margin-bottom:28px; }
.upload-section h2 { font-size:18px; font-weight:700; margin-bottom:16px; letter-spacing:-0.3px; }
.upload-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; }
.upload-box { background:var(--surface); border:2px dashed var(--border); border-radius:var(--radius); padding:32px 24px; text-align:center; cursor:pointer; transition:all .2s; position:relative; }
.upload-box:hover { border-color:var(--accent); background:var(--surface2); }
.upload-box.loaded { border-color:var(--green); border-style:solid; }
.upload-box .icon { font-size:28px; margin-bottom:10px; }
.upload-box .label { font-size:14px; font-weight:600; margin-bottom:4px; }
.upload-box .hint { font-size:12px; color:var(--text2); }
.upload-box .status { font-size:12px; margin-top:10px; font-weight:600; }
.upload-box .status.ok { color:var(--green); }
.upload-box .status.err { color:var(--red); }
.upload-box input[type=file] { display:none; }
.upload-box.dragover { border-color:var(--accent); background:var(--surface2); transform:scale(1.02); }

/* TABLE */
.table-wrap { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; }
.table-header { display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid var(--border); }
.table-header h2 { font-size:15px; font-weight:700; }
.table-header .count { font-size:13px; color:var(--text2); }
.search-bar { display:flex; gap:10px; align-items:center; }
.search-bar input { padding:8px 14px; background:var(--bg); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:13px; width:260px; font-family:inherit; }
.search-bar input:focus { outline:none; border-color:var(--accent); }
.search-bar select { padding:8px 12px; background:var(--bg); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:13px; font-family:inherit; }
.btn { padding:8px 16px; border:none; border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; font-family:inherit; transition:all .15s; }
.btn-accent { background:var(--accent); color:#000; }
.btn-accent:hover { background:var(--accent2); }
.btn-outline { background:transparent; border:1px solid var(--border); color:var(--text); }
.btn-outline:hover { border-color:var(--text2); }
.btn-green { background:var(--green); color:#000; }

table { width:100%; border-collapse:collapse; font-size:13px; }
thead { background:var(--surface2); }
th { padding:10px 14px; text-align:left; font-weight:600; font-size:12px; color:var(--text2); text-transform:uppercase; letter-spacing:.5px; white-space:nowrap; border-bottom:1px solid var(--border); }
td { padding:10px 14px; border-bottom:1px solid var(--border); white-space:nowrap; }
tr:hover td { background:rgba(245,197,24,.03); }
.text-right { text-align:right; }
.text-center { text-align:center; }
.badge { display:inline-block; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:600; }
.badge-green { background:rgba(52,211,153,.15); color:var(--green); }
.badge-red { background:rgba(248,113,113,.15); color:var(--red); }
.badge-orange { background:rgba(251,146,60,.15); color:var(--orange); }
.badge-blue { background:rgba(96,165,250,.15); color:var(--blue); }
.badge-purple { background:rgba(167,139,250,.15); color:var(--purple); }
.table-scroll { max-height:600px; overflow-y:auto; }
.table-scroll::-webkit-scrollbar { width:6px; }
.table-scroll::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

/* PANEL */
.panel { display:none; }
.panel.active { display:block; }

/* ABGLEICH */
.match-summary { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:24px; }
.action-bar { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }

/* RESPONSIVE */
@media(max-width:1024px) {
  .grid-3, .upload-grid, .match-summary { grid-template-columns:1fr; }
  main { padding:20px 16px; }
}

/* EMPTY STATE */
.empty { text-align:center; padding:60px 20px; color:var(--text2); }
.empty .icon { font-size:48px; margin-bottom:12px; opacity:.4; }
.empty p { font-size:14px; }

/* TOAST */
.toast { position:fixed; bottom:24px; right:24px; background:var(--green); color:#000; padding:12px 20px; border-radius:8px; font-size:13px; font-weight:600; z-index:999; opacity:0; transform:translateY(10px); transition:all .3s; }
.toast.show { opacity:1; transform:translateY(0); }

/* ROW STATUS */
tr.row-code-1 td { background:rgba(96,165,250,.08); }
tr.row-code-1:hover td { background:rgba(96,165,250,.14); }
tr.row-code-2 td { background:rgba(248,113,113,.08); }
tr.row-code-2:hover td { background:rgba(248,113,113,.14); }
tr.row-code-3 td { background:rgba(167,139,250,.08); }
tr.row-code-3:hover td { background:rgba(167,139,250,.14); }
tr.row-code-4 td { background:rgba(251,146,60,.08); }
tr.row-code-4:hover td { background:rgba(251,146,60,.14); }
tr.row-unknown td { background:rgba(136,145,164,.06); }
tr.row-unknown:hover td { background:rgba(136,145,164,.12); }
.code-label { display:inline-flex; align-items:center; gap:6px; }
.code-dot { width:8px; height:8px; border-radius:50%; display:inline-block; flex-shrink:0; }
.code-dot.green { background:var(--green); }
.code-dot.blue { background:var(--blue); }
.code-dot.red { background:var(--red); }
.code-dot.purple { background:var(--purple); }
.code-dot.orange { background:var(--orange); }
.code-dot.gray { background:var(--text2); }
.section-block { margin-bottom:24px; }
.section-block .section-head { display:flex; align-items:center; justify-content:space-between; padding:14px 20px; border-bottom:1px solid var(--border); }
.section-block .section-head h3 { font-size:14px; font-weight:700; display:flex; align-items:center; gap:8px; }
.section-block .section-head .cnt { font-size:13px; color:var(--text2); }
.match-summary { grid-template-columns:repeat(6,1fr); }

/* FOOTER */
footer { text-align:center; padding:20px; font-size:12px; color:var(--text2); border-top:1px solid var(--border); margin-top:40px; }
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div id="auth-box">
    <h1>Renault V4</h1>
    <div class="sub">Teile-Zentrale</div>
    <input type="text" id="auth-user" placeholder="Benutzer" autofocus>
    <input type="password" id="auth-pass" placeholder="Passwort" onkeydown="if(event.key==='Enter')doLogin()">
    <button onclick="doLogin()">Anmelden</button>
    <div class="auth-err" id="auth-err">Falscher Benutzer oder Passwort</div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <header>
    <h1>Renault <span>V4</span> — Teile-Zentrale</h1>
    <span class="user">Smarty's Autozubehör · DLNR 7455</span>
  </header>

  <div class="tabs">
    <div class="tab active" onclick="showPanel('dashboard')">Dashboard</div>
    <div class="tab" onclick="showPanel('stammdaten')">Stammdaten</div>
    <div class="tab" onclick="showPanel('bestellung')">Bestellung</div>
    <div class="tab" onclick="showPanel('abgleich')">Margenanalyse</div>
    <div class="tab" onclick="showPanel('css-export')">CSS Export</div>
  </div>

  <!-- DASHBOARD -->
  <main>
    <div class="panel active" id="panel-dashboard">
      <div class="upload-section">
        <h2>Dateien laden</h2>
        <div class="upload-grid">
          <div class="upload-box" id="box-stamm" onclick="this.querySelector('input').click()">
            <input type="file" accept=".txt,.dat,.csv,*" onchange="loadStammdaten(this.files[0])">
            <div class="icon">&#9776;</div>
            <div class="label">Renault Stammdaten</div>
            <div class="hint">TLDRAGP / Festformat 256 Zeichen</div>
            <div class="status" id="status-stamm"></div>
          </div>
          <div class="upload-box" id="box-order" onclick="this.querySelector('input').click()">
            <input type="file" accept=".xlsx,.xls" onchange="loadBestellung(this.files[0])">
            <div class="icon">&#9993;</div>
            <div class="label">Kundenbestellung</div>
            <div class="hint">Excel mit POST REF / REF / Menge / Preis</div>
            <div class="status" id="status-order"></div>
          </div>
          <div class="upload-box" id="box-css" onclick="this.querySelector('input').click()">
            <input type="file" accept=".csv,.txt" onchange="loadCssData(this.files[0])">
            <div class="icon">&#9881;</div>
            <div class="label">CSS/ERP Stammdaten</div>
            <div class="hint">CSV: article;list_price;buying_price;...</div>
            <div class="status" id="status-css"></div>
          </div>
        </div>
      </div>

      <div class="grid-3">
        <div class="card">
          <h3>Renault Stammdaten</h3>
          <div class="num accent" id="count-stamm">—</div>
          <div class="detail" id="detail-stamm">Keine Datei geladen</div>
        </div>
        <div class="card">
          <h3>Bestellpositionen</h3>
          <div class="num blue" id="count-order">—</div>
          <div class="detail" id="detail-order">Keine Datei geladen</div>
        </div>
        <div class="card">
          <h3>CSS/ERP Artikel</h3>
          <div class="num green" id="count-css">—</div>
          <div class="detail" id="detail-css">Keine Datei geladen</div>
        </div>
      </div>
    </div>

    <!-- STAMMDATEN -->
    <div class="panel" id="panel-stammdaten">
      <div class="table-wrap">
        <div class="table-header">
          <h2>Renault Stammdaten (RDAGTK)</h2>
          <div class="search-bar">
            <input type="text" id="search-stamm" placeholder="Teilenummer oder Bezeichnung..." oninput="renderStammTable()">
            <span class="count" id="count-stamm-tbl"></span>
          </div>
        </div>
        <div class="table-scroll" id="stamm-table-wrap">
          <div class="empty" id="empty-stamm"><div class="icon">&#9776;</div><p>Renault Stammdatei (TLDRAGP) hochladen</p></div>
        </div>
      </div>
    </div>

    <!-- BESTELLUNG -->
    <div class="panel" id="panel-bestellung">
      <div class="match-summary" id="order-summary" style="display:none;">
        <div class="card" style="border-left:3px solid var(--green);">
          <h3>Gültig</h3>
          <div class="num green" id="order-sum-ok">0</div>
        </div>
        <div class="card" style="border-left:3px solid var(--blue);">
          <h3>Austauschbar (1)</h3>
          <div class="num blue" id="order-sum-1">0</div>
        </div>
        <div class="card" style="border-left:3px solid var(--red);">
          <h3>Wird ersetzt (2)</h3>
          <div class="num red" id="order-sum-2">0</div>
        </div>
        <div class="card" style="border-left:3px solid var(--purple);">
          <h3>Nicht lieferbar (3)</h3>
          <div class="num" style="color:var(--purple)" id="order-sum-3">0</div>
        </div>
        <div class="card" style="border-left:3px solid var(--orange);">
          <h3>Gesperrt (4)</h3>
          <div class="num orange" id="order-sum-4">0</div>
        </div>
        <div class="card" style="border-left:3px solid var(--text2);">
          <h3>Nicht in Stammdaten</h3>
          <div class="num" style="color:var(--text2)" id="order-sum-unknown">0</div>
        </div>
      </div>
      <div class="action-bar" id="order-actions" style="display:none;">
        <button class="btn btn-accent" onclick="exportOrderExcel('all')">Alle als Excel</button>
        <button class="btn" style="background:var(--green);color:#000" onclick="exportOrderExcel('ok')">Gültige</button>
        <button class="btn" style="background:var(--blue);color:#000" onclick="exportOrderExcel('1')">Austauschbar (1)</button>
        <button class="btn" style="background:var(--red);color:#000" onclick="exportOrderExcel('2')">Wird ersetzt (2)</button>
        <button class="btn" style="background:var(--purple);color:#000" onclick="exportOrderExcel('3')">Nicht lieferbar (3)</button>
        <button class="btn" style="background:var(--orange);color:#000" onclick="exportOrderExcel('4')">Gesperrt (4)</button>
        <button class="btn btn-outline" onclick="exportOrderExcel('unknown')">Nicht in Stammdaten</button>
      </div>
      <div id="order-sections">
        <div class="empty" id="empty-order"><div class="icon">&#9993;</div><p>Bestelldatei (Excel) + Stammdaten hochladen</p></div>
      </div>
    </div>

    <!-- ABGLEICH / MARGENANALYSE -->
    <div class="panel" id="panel-abgleich">
      <!-- Gesamtübersicht -->
      <div id="margin-overview" style="display:none;">
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:16px;">
          <div class="card" style="border-left:3px solid var(--accent)">
            <h3>Auftragswert (Kundenpreis)</h3>
            <div class="num accent" id="mg-total-vk">0,00 €</div>
            <div class="detail" id="mg-total-pos">0 Positionen</div>
          </div>
          <div class="card" style="border-left:3px solid var(--blue)">
            <h3>Dein EK (buying_price_self)</h3>
            <div class="num blue" id="mg-total-ek">0,00 €</div>
            <div class="detail">Summe aller EK Eigen x Menge</div>
          </div>
          <div class="card" style="border-left:3px solid var(--green)">
            <h3>Gesamtmarge</h3>
            <div class="num green" id="mg-total-marge">0,00 €</div>
            <div class="detail" id="mg-total-pct">0,0 %</div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px;">
          <div class="card">
            <h3>In CSS gefunden</h3>
            <div class="num green" id="mg-found">0</div>
          </div>
          <div class="card">
            <h3>Nicht in CSS</h3>
            <div class="num red" id="mg-missing">0</div>
          </div>
          <div class="card">
            <h3>Preisabweichung</h3>
            <div class="num orange" id="mg-ek-diff">0</div>
            <div class="detail">Best.-Preis ≠ CSS KD-Preis</div>
          </div>
          <div class="card">
            <h3>Negative Marge</h3>
            <div class="num red" id="mg-negative">0</div>
            <div class="detail">Verlust-Positionen</div>
          </div>
        </div>
      </div>

      <div class="action-bar">
        <button class="btn btn-accent" onclick="runAbgleich()">Margenanalyse starten</button>
        <button class="btn btn-outline" onclick="exportAbgleichExcel('all')">Alle als Excel</button>
        <button class="btn" style="background:var(--orange);color:#000" onclick="exportAbgleichExcel('diff')">Nur Abweichungen</button>
        <button class="btn" style="background:var(--red);color:#000" onclick="exportAbgleichExcel('negative')">Nur Verluste</button>
        <button class="btn btn-outline" onclick="exportAbgleichExcel('missing')">Nicht in CSS</button>
        <span style="width:1px;height:24px;background:var(--border);display:inline-block;margin:0 6px"></span>
        <button class="btn" style="background:var(--purple);color:#fff" id="btn-css-query" onclick="startCssQuery()">CSS Warenwirtschaft abfragen</button>
        <span id="css-query-status" style="font-size:12px;color:var(--text2)"></span>
      </div>

      <div class="table-wrap">
        <div class="table-header">
          <h2>Margenanalyse: Gültige Bestellpositionen ↔ CSS/ERP</h2>
          <div class="search-bar">
            <select id="filter-match" onchange="renderMatchTable()">
              <option value="all">Alle</option>
              <option value="found">In CSS (OK)</option>
              <option value="missing">Nicht in CSS</option>
              <option value="diff">Preisabweichung (Best. ≠ CSS)</option>
              <option value="negative">Negative Marge</option>
              <option value="high">Marge > 50%</option>
              <option value="low">Marge < 20%</option>
            </select>
            <input type="text" id="search-match" placeholder="Suche..." oninput="renderMatchTable()">
            <span class="count" id="count-match-tbl"></span>
          </div>
        </div>
        <div class="table-scroll" id="match-table-wrap">
          <div class="empty"><div class="icon">&#8596;</div><p>Bestellung + Stammdaten + CSS Datei laden, dann "Margenanalyse starten"</p></div>
        </div>
      </div>
    </div>

    <!-- CSS EXPORT -->
    <div class="panel" id="panel-css-export">
      <div class="table-wrap">
        <div class="table-header">
          <h2>CSS/ERP Stammdaten</h2>
          <div class="search-bar">
            <input type="text" id="search-css" placeholder="Artikel suchen..." oninput="renderCssTable()">
            <button class="btn btn-green" onclick="downloadCssExport()">CSV Export</button>
            <span class="count" id="count-css-tbl"></span>
          </div>
        </div>
        <div class="table-scroll" id="css-table-wrap">
          <div class="empty" id="empty-css"><div class="icon">&#9881;</div><p>CSS/ERP Datei hochladen</p></div>
        </div>
      </div>
    </div>
  </main>

  <footer>Renault V4 · Smarty's Autozubehör · DLNR 7455</footer>
</div>

<div class="toast" id="toast"></div>

<script>
// ── DRAG & DROP ──
function setupDrop(boxId, handler) {
  const box = document.getElementById(boxId);
  ['dragenter','dragover'].forEach(ev => box.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); box.classList.add('dragover'); }));
  ['dragleave','drop'].forEach(ev => box.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); box.classList.remove('dragover'); }));
  box.addEventListener('drop', e => { if (e.dataTransfer.files.length) handler(e.dataTransfer.files[0]); });
}
document.addEventListener('DOMContentLoaded', () => {
  setupDrop('box-stamm', loadStammdaten);
  setupDrop('box-order', loadBestellung);
  setupDrop('box-css', loadCssData);
});

// ── AUTH ──
function doLogin() {
  const u = document.getElementById('auth-user').value.trim();
  const p = document.getElementById('auth-pass').value;
  if (u === 'oe' && p === 'deals!!@1234#') {
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
  } else {
    document.getElementById('auth-err').style.display = 'block';
  }
}

// ── DATA STORES ──
let stammData = [];    // parsed Renault master data
let orderData = [];    // parsed order rows
let cssData = [];      // parsed CSS/ERP data
let cssMap = {};       // article -> css row
let stammMap = {};     // teilenr -> stamm row
let matchData = [];    // abgleich results

// ── PANELS ──
function showPanel(name) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  document.querySelectorAll('.tab')[['dashboard','stammdaten','bestellung','abgleich','css-export'].indexOf(name)].classList.add('active');
}

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// ── PARSE RENAULT STAMMDATEN (Semikolon-getrennt) ──
// Felder: 1=RDAGTK, 2=Version, 3=Datum, 4=Zeit, 5=Satzzähler, 6=Satzanzahl,
// 7=Teilenummer, 8=Teile-Code, 9=Austausch-Nr, 10=Bezeichnung-1, 11=Bezeichnung-2,
// 12=Brutto(Cent), 13=Währung, 14=MwSt-Code, 15=Nettopreis-Code,
// 16=Rabattgruppe, 17=R1-Bonus, 18=Pfandwert, 19=VPE, 20=Gewicht(g),
// 21=Volumen, 22=Familie, 23=Segment, ...
function parseStammdaten(text) {
  const lines = text.split(/\r?\n/).filter(l => l.length > 10);
  const rows = [];
  for (const line of lines) {
    const f = line.split(';');
    if (f[0] !== 'RDAGTK' || f.length < 16) continue;
    const teilenr = (f[6] || '').trim();
    if (!teilenr) continue;
    const code = (f[7] || '').trim();
    const austausch = (f[8] || '').trim();
    const bez1 = (f[9] || '').trim();
    const bez2 = (f[10] || '').trim();
    const bruttoStr = (f[11] || '').trim();
    const brutto = bruttoStr ? parseInt(bruttoStr) / 100 : 0;
    const waehrung = (f[12] || '').trim();
    const mwstCode = (f[13] || '').trim();
    const nettoCode = (f[14] || '').trim();
    const rabattgruppe = (f[15] || '').trim();
    const gewicht = parseInt((f[19] || '').trim()) || 0;
    const familie = (f[21] || '').trim();
    rows.push({
      teilenr, code, austausch,
      bezeichnung: (bez1 + ' ' + bez2).trim(),
      brutto, waehrung, mwstCode, nettoCode,
      rabattgruppe, gewicht, familie
    });
  }
  return rows;
}

function loadStammdaten(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      stammData = parseStammdaten(e.target.result);
      stammMap = {};
      stammData.forEach(r => stammMap[r.teilenr.replace(/\s+/g,'').toUpperCase()] = r);
      document.getElementById('box-stamm').classList.add('loaded');
      document.getElementById('status-stamm').className = 'status ok';
      document.getElementById('status-stamm').textContent = stammData.length.toLocaleString('de') + ' Teile geladen';
      document.getElementById('count-stamm').textContent = stammData.length.toLocaleString('de');
      document.getElementById('detail-stamm').textContent = 'RDAGTK Datei: ' + file.name;
      renderStammTable();
      if (orderData.length) renderOrderTable(); // Re-render Bestellung with validity
      toast(stammData.length.toLocaleString('de') + ' Stammdaten geladen');
    } catch (err) {
      document.getElementById('status-stamm').className = 'status err';
      document.getElementById('status-stamm').textContent = 'Fehler: ' + err.message;
    }
  };
  reader.readAsText(file, 'ISO-8859-1');
}

// ── PARSE BESTELLUNG (Excel) ──
function loadBestellung(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const wb = XLSX.read(e.target.result, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws);
      orderData = json.filter(r => r['REF'] || r['ref']).map(r => ({
        postRef: r['POST REF'] || r['post ref'] || '',
        beschreibung: r['BESCHREIBUNG'] || r['beschreibung'] || r['Beschreibung'] || '',
        menge: parseInt(r['MENGE'] || r['menge'] || r['Menge'] || 0),
        ref: String(r['REF'] || r['ref'] || r['Ref'] || '').trim(),
        preis: parseFloat(r['PREIS'] || r['preis'] || r['Preis'] || 0),
        gesamt: parseFloat(r['GESAMT'] || r['gesamt'] || r['Gesamt'] || 0)
      }));
      document.getElementById('box-order').classList.add('loaded');
      document.getElementById('status-order').className = 'status ok';
      document.getElementById('status-order').textContent = orderData.length + ' Positionen geladen';
      document.getElementById('count-order').textContent = orderData.length;
      document.getElementById('detail-order').textContent = 'Datei: ' + file.name;
      renderOrderTable();
      toast(orderData.length + ' Bestellpositionen geladen');
    } catch (err) {
      document.getElementById('status-order').className = 'status err';
      document.getElementById('status-order').textContent = 'Fehler: ' + err.message;
    }
  };
  reader.readAsArrayBuffer(file);
}

// ── PARSE CSS/ERP (CSV) ──
function loadCssData(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const lines = e.target.result.split(/\r?\n/).filter(l => l.trim());
      const header = lines[0].split(';');
      cssData = [];
      cssMap = {};
      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(';');
        if (cols.length < 8) continue;
        const row = {
          article: cols[0]?.trim() || '',
          listPrice: parseFloat(cols[1]) || 0,
          buyingPrice: parseFloat(cols[2]) || 0,
          buyingPriceSelf: parseFloat(cols[3]) || 0,
          discount: parseFloat(cols[4]) || 0,
          discountSelf: parseFloat(cols[5]) || 0,
          description: cols[6]?.trim() || '',
          weight: parseInt(cols[7]) || 0,
          dlnr: cols[8]?.trim() || '7455'
        };
        cssData.push(row);
        cssMap[row.article] = row;
      }
      document.getElementById('box-css').classList.add('loaded');
      document.getElementById('status-css').className = 'status ok';
      document.getElementById('status-css').textContent = cssData.length.toLocaleString('de') + ' Artikel geladen';
      document.getElementById('count-css').textContent = cssData.length.toLocaleString('de');
      document.getElementById('detail-css').textContent = 'Datei: ' + file.name;
      renderCssTable();
      toast(cssData.length.toLocaleString('de') + ' CSS Artikel geladen');
    } catch (err) {
      document.getElementById('status-css').className = 'status err';
      document.getElementById('status-css').textContent = 'Fehler: ' + err.message;
    }
  };
  reader.readAsText(file, 'UTF-8');
}

// ── RENDER TABLES ──
function fmt(n) { return n.toFixed(2).replace('.', ','); }
function fmtP(n) { return n.toFixed(2); }

function renderStammTable() {
  const wrap = document.getElementById('stamm-table-wrap');
  if (!stammData.length) return;
  const q = (document.getElementById('search-stamm').value || '').toLowerCase();
  const filtered = q ? stammData.filter(r =>
    r.teilenr.toLowerCase().includes(q) || r.bezeichnung.toLowerCase().includes(q)
  ) : stammData;
  document.getElementById('count-stamm-tbl').textContent = filtered.length.toLocaleString('de') + ' / ' + stammData.length.toLocaleString('de');
  const rows = filtered.slice(0, 500);
  wrap.innerHTML = `<table>
    <thead><tr>
      <th>Teilenummer</th><th>Bezeichnung</th><th class="text-right">Brutto EUR</th>
      <th>Code</th><th>RG</th><th>Familie</th><th class="text-right">Gewicht g</th>
    </tr></thead>
    <tbody>${rows.map(r => `<tr>
      <td class="mono">${r.teilenr}</td>
      <td>${r.bezeichnung}</td>
      <td class="text-right mono">${fmt(r.brutto)}</td>
      <td class="text-center">${r.code || '—'}</td>
      <td class="text-center">${r.rabattgruppe || '—'}</td>
      <td class="mono">${r.familie || '—'}</td>
      <td class="text-right mono">${r.gewicht || '—'}</td>
    </tr>`).join('')}</tbody>
  </table>${filtered.length > 500 ? '<div style="padding:12px;text-align:center;color:var(--text2);font-size:12px;">Zeige 500 von ' + filtered.length.toLocaleString('de') + '</div>' : ''}`;
}

// Teile-Code Beschreibungen
const TEILE_CODES = {
  '':  { label: 'Gültig', color: 'green', dotCls: 'green', rowCls: '', category: 'ok' },
  '1': { label: 'Austauschbar mit Folgenummer', color: 'blue', dotCls: 'blue', rowCls: 'row-code-1', category: '1' },
  '2': { label: 'Wird ersetzt durch Folgenummer', color: 'red', dotCls: 'red', rowCls: 'row-code-2', category: '2' },
  '3': { label: 'Nicht mehr lieferbar', color: 'purple', dotCls: 'purple', rowCls: 'row-code-3', category: '3' },
  '4': { label: 'Gesperrt, wird später geliefert', color: 'orange', dotCls: 'orange', rowCls: 'row-code-4', category: '4' }
};

const CATEGORY_META = {
  'ok':      { title: 'Gültig', dotCls: 'green', borderColor: 'var(--green)' },
  '1':       { title: 'Austauschbar mit Folgenummer (Code 1)', dotCls: 'blue', borderColor: 'var(--blue)' },
  '2':       { title: 'Wird ersetzt durch Folgenummer (Code 2)', dotCls: 'red', borderColor: 'var(--red)' },
  '3':       { title: 'Nicht mehr lieferbar (Code 3)', dotCls: 'purple', borderColor: 'var(--purple)' },
  '4':       { title: 'Gesperrt, wird später geliefert (Code 4)', dotCls: 'orange', borderColor: 'var(--orange)' },
  'unknown': { title: 'Nicht in Stammdaten gefunden', dotCls: 'gray', borderColor: 'var(--text2)' }
};

let enrichedOrderData = [];

function lookupStamm(ref) {
  const r = normalizeRef(ref);
  return stammMap[r] || stammMap[r.replace(/^0+/, '')] || null;
}

function buildOrderRow(r, showAustausch) {
  let extra = '';
  if (showAustausch) {
    if (r.validity.austausch) {
      const neuStamm = lookupStamm(r.validity.austausch);
      const altStamm = lookupStamm(r.ref);
      const altPreis = altStamm ? altStamm.brutto : 0;
      const neuPreis = neuStamm ? neuStamm.brutto : 0;
      const neuBez = neuStamm ? neuStamm.bezeichnung : '—';
      const diff = neuPreis - altPreis;
      const diffColor = diff > 0.01 ? 'var(--red)' : diff < -0.01 ? 'var(--green)' : 'var(--text2)';
      const diffPrefix = diff > 0 ? '+' : '';
      const hasBoth = altPreis > 0 && neuPreis > 0;
      extra = '<td class="mono" style="color:var(--accent);font-weight:600">' + r.validity.austausch + '</td>'
        + '<td>' + neuBez + '</td>'
        + '<td class="text-right mono">' + (altPreis ? fmt(altPreis) : '—') + '</td>'
        + '<td class="text-right mono">' + (neuPreis ? fmt(neuPreis) : '—') + '</td>'
        + '<td class="text-right mono" style="color:' + diffColor + ';font-weight:600">' + (hasBoth ? diffPrefix + fmt(diff) : '—') + '</td>';
    } else {
      extra = '<td>—</td><td>—</td><td>—</td><td>—</td><td>—</td>';
    }
  }
  return '<tr class="' + r.validity.rowCls + '">'
    + '<td class="mono">' + r.postRef + '</td>'
    + '<td>' + r.beschreibung + '</td>'
    + '<td class="text-center">' + r.menge + '</td>'
    + '<td class="mono">' + r.ref + '</td>'
    + '<td class="text-right mono">' + fmt(r.preis) + '</td>'
    + '<td class="text-right mono">' + fmt(r.gesamt) + '</td>'
    + '<td class="text-center"><span class="code-label"><span class="code-dot ' + r.validity.dotCls + '"></span>' + (r.validity.code || '—') + '</span></td>'
    + extra + '</tr>';
}

function getOrderValidity(order) {
  const ref = normalizeRef(order.ref);
  let stamm = stammMap[ref];
  if (!stamm) stamm = stammMap[ref.replace(/^0+/, '')];
  if (!stamm) {
    for (const key of Object.keys(stammMap)) {
      if (key.replace(/^0+/, '') === ref.replace(/^0+/, '')) { stamm = stammMap[key]; break; }
    }
  }
  if (!stamm) return { status: 'unknown', label: 'Nicht in Stammdaten', dotCls: 'gray', rowCls: 'row-unknown', austausch: '', code: '', category: 'unknown' };
  const code = stamm.code || '';
  const info = TEILE_CODES[code] || TEILE_CODES[''];
  return { ...info, austausch: stamm.austausch || '', code };
}

function renderOrderTable() {
  const container = document.getElementById('order-sections');
  if (!orderData.length || !stammData.length) return;

  enrichedOrderData = orderData.map(r => ({ ...r, validity: getOrderValidity(r) }));

  // Count per category
  const counts = { ok: 0, '1': 0, '2': 0, '3': 0, '4': 0, unknown: 0 };
  enrichedOrderData.forEach(r => counts[r.validity.category] = (counts[r.validity.category] || 0) + 1);

  // Summary
  document.getElementById('order-summary').style.display = 'grid';
  document.getElementById('order-sum-ok').textContent = counts.ok;
  document.getElementById('order-sum-1').textContent = counts['1'];
  document.getElementById('order-sum-2').textContent = counts['2'];
  document.getElementById('order-sum-3').textContent = counts['3'];
  document.getElementById('order-sum-4').textContent = counts['4'];
  document.getElementById('order-sum-unknown').textContent = counts.unknown;
  document.getElementById('order-actions').style.display = 'flex';

  // Build sections
  const categories = ['ok', '1', '2', '3', '4', 'unknown'];
  let html = '';
  for (const cat of categories) {
    const items = enrichedOrderData.filter(r => r.validity.category === cat);
    if (items.length === 0) continue;
    const meta = CATEGORY_META[cat];
    const showAustausch = cat === '1' || cat === '2';

    html += `<div class="section-block">
      <div class="table-wrap" style="border-left:3px solid ${meta.borderColor}">
        <div class="section-head">
          <h3><span class="code-dot ${meta.dotCls}"></span>${meta.title}</h3>
          <div style="display:flex;align-items:center;gap:12px;">
            <span class="cnt">${items.length} Positionen</span>
            <button class="btn btn-outline" style="padding:5px 12px;font-size:12px" onclick="exportOrderExcel('${cat}')">Excel</button>
          </div>
        </div>
        <div class="table-scroll">
          <table>
            <thead><tr>
              <th>POST REF</th><th>Beschreibung</th><th class="text-center">Menge</th>
              <th>REF (Teilenr)</th><th class="text-right">Preis</th><th class="text-right">Gesamt</th>
              <th>Teile-Code</th>
              ${showAustausch ? '<th>Neue Nr</th><th>Neue Bezeichnung</th><th class="text-right">Alter Brutto</th><th class="text-right">Neuer Brutto</th><th class="text-right">Differenz</th>' : ''}
            </tr></thead>
            <tbody>${items.map(r => buildOrderRow(r, showAustausch)).join('')}</tbody>
          </table>
        </div>
      </div>
    </div>`;
  }
  container.innerHTML = html;
}

// ── EXCEL EXPORT pro Rubrik ──
function exportOrderExcel(category) {
  if (!enrichedOrderData.length) { toast('Keine Daten'); return; }
  const items = category === 'all' ? enrichedOrderData : enrichedOrderData.filter(r => r.validity.category === category);
  if (!items.length) { toast('Keine Einträge in dieser Rubrik'); return; }

  const rows = items.map(r => {
    const row = {
      'POST REF': r.postRef,
      'Beschreibung': r.beschreibung,
      'Menge': r.menge,
      'REF (Teilenr)': r.ref,
      'Preis': r.preis,
      'Gesamt': r.gesamt,
      'Teile-Code': r.validity.code || '',
      'Status': r.validity.label,
    };
    if (r.validity.austausch) {
      const neuStamm = lookupStamm(r.validity.austausch);
      const altStamm = lookupStamm(r.ref);
      row['Austausch-Nr'] = r.validity.austausch;
      row['Neue Bezeichnung'] = neuStamm ? neuStamm.bezeichnung : '';
      row['Alter Brutto'] = altStamm ? altStamm.brutto : '';
      row['Neuer Brutto'] = neuStamm ? neuStamm.brutto : '';
      if (altStamm && neuStamm) row['Differenz'] = neuStamm.brutto - altStamm.brutto;
    }
    return row;
  });

  const ws = XLSX.utils.json_to_sheet(rows);

  // Column widths
  ws['!cols'] = [
    { wch: 14 }, { wch: 40 }, { wch: 8 }, { wch: 14 },
    { wch: 10 }, { wch: 10 }, { wch: 12 }, { wch: 30 }, { wch: 14 }
  ];

  const wb = XLSX.utils.book_new();
  const catLabel = category === 'all' ? 'Alle' : (CATEGORY_META[category]?.title || category);
  XLSX.utils.book_append_sheet(wb, ws, catLabel.substring(0, 31));
  XLSX.writeFile(wb, `Bestellung_${category === 'all' ? 'Komplett' : 'Code_' + category}.xlsx`);
  toast('Excel Export: ' + catLabel);
}

function renderCssTable() {
  const wrap = document.getElementById('css-table-wrap');
  if (!cssData.length) return;
  const q = (document.getElementById('search-css').value || '').toLowerCase();
  const filtered = q ? cssData.filter(r =>
    r.article.toLowerCase().includes(q) || r.description.toLowerCase().includes(q)
  ) : cssData;
  document.getElementById('count-css-tbl').textContent = filtered.length.toLocaleString('de') + ' / ' + cssData.length.toLocaleString('de');
  const rows = filtered.slice(0, 500);
  wrap.innerHTML = `<table>
    <thead><tr>
      <th>Artikel</th><th>Bezeichnung</th><th class="text-right">LP</th>
      <th class="text-right">EK</th><th class="text-right">EK Eigen</th>
      <th class="text-right">Rabatt %</th><th class="text-right">Rabatt Eigen %</th><th class="text-right">Gewicht</th>
    </tr></thead>
    <tbody>${rows.map(r => `<tr>
      <td class="mono">${r.article}</td>
      <td>${r.description}</td>
      <td class="text-right mono">${fmtP(r.listPrice)}</td>
      <td class="text-right mono">${fmtP(r.buyingPrice)}</td>
      <td class="text-right mono">${fmtP(r.buyingPriceSelf)}</td>
      <td class="text-right mono">${fmtP(r.discount)}</td>
      <td class="text-right mono">${fmtP(r.discountSelf)}</td>
      <td class="text-right mono">${r.weight}</td>
    </tr>`).join('')}</tbody>
  </table>${filtered.length > 500 ? '<div style="padding:12px;text-align:center;color:var(--text2);font-size:12px;">Zeige 500 von ' + filtered.length.toLocaleString('de') + '</div>' : ''}`;
}

// ── MARGENANALYSE ──
function normalizeRef(ref) {
  return String(ref).replace(/\s+/g, '').toUpperCase();
}

function runAbgleich() {
  if (!enrichedOrderData.length && !orderData.length) { toast('Keine Bestellung geladen'); return; }
  if (!cssData.length) { toast('Keine CSS Daten geladen'); return; }

  // Only analyze OK (valid) items
  const okItems = enrichedOrderData.length
    ? enrichedOrderData.filter(r => r.validity?.category === 'ok')
    : orderData;

  if (!okItems.length) { toast('Keine gültigen Positionen gefunden'); return; }

  let totalVK = 0, totalEK = 0, foundCount = 0, missingCount = 0, diffCount = 0, negCount = 0;

  matchData = okItems.map(order => {
    const ref = normalizeRef(order.ref);
    let css = cssMap[ref];
    if (!css) css = cssMap[ref.replace(/^0+/, '')];
    // Try fuzzy match without leading zeros
    if (!css) {
      for (const key of Object.keys(cssMap)) {
        if (key.replace(/^0+/, '') === ref.replace(/^0+/, '')) { css = cssMap[key]; break; }
      }
    }

    const kundenPreis = order.preis || 0;      // VK per unit
    const kundenGesamt = order.gesamt || 0;     // VK total
    const menge = order.menge || 1;

    let ekPerUnit = 0, ekGesamt = 0, margePerUnit = 0, margeGesamt = 0, margePct = 0;
    let status = 'missing';

    var cssKdPreis = 0, preisMatch = false;

    if (css) {
      cssKdPreis = css.buyingPrice;          // KD-Preis laut CSS Preisliste
      ekPerUnit = css.buyingPriceSelf;        // Dein EK (buying_price_self)
      ekGesamt = ekPerUnit * menge;
      margePerUnit = kundenPreis - ekPerUnit;
      margeGesamt = margePerUnit * menge;
      margePct = kundenPreis > 0 ? (margePerUnit / kundenPreis) * 100 : 0;

      // Prüfe ob KD-Preis aus Bestellung mit CSS Preisliste übereinstimmt
      preisMatch = Math.abs(kundenPreis - cssKdPreis) < 0.01;

      status = 'found';
      if (margePerUnit < 0) { status = 'negative'; negCount++; }
      if (!preisMatch) diffCount++;
      foundCount++;
    } else {
      missingCount++;
    }

    totalVK += kundenGesamt;
    totalEK += ekGesamt;

    return {
      ...order, ref, css, status,
      ekPerUnit, ekGesamt, margePerUnit, margeGesamt, margePct, menge,
      cssKdPreis, preisMatch
    };
  });

  // Check for EK deviations (where CSS LP != Renault Brutto from Stammdaten)
  matchData.forEach(r => {
    if (r.css && r.margePct < 0.01) {
      // Mark items with very thin margin as diff
    }
  });
  diffCount = matchData.filter(r => r.css && r.margePct !== 0 && Math.abs(r.margePct) < 10).length;

  const totalMarge = totalVK - totalEK;
  const totalPct = totalVK > 0 ? (totalMarge / totalVK) * 100 : 0;

  // Update UI
  document.getElementById('margin-overview').style.display = 'block';
  document.getElementById('mg-total-vk').textContent = fmt(totalVK) + ' €';
  document.getElementById('mg-total-pos').textContent = matchData.length + ' gültige Positionen, ' + matchData.reduce((s, r) => s + r.menge, 0) + ' Stück';
  document.getElementById('mg-total-ek').textContent = fmt(totalEK) + ' €';
  document.getElementById('mg-total-marge').textContent = fmt(totalMarge) + ' €';
  document.getElementById('mg-total-pct').textContent = fmt(totalPct) + ' % Durchschnittsmarge';
  document.getElementById('mg-found').textContent = foundCount;
  document.getElementById('mg-missing').textContent = missingCount;
  document.getElementById('mg-ek-diff').textContent = matchData.filter(r => r.css && !r.preisMatch).length;
  document.getElementById('mg-negative').textContent = matchData.filter(r => r.margePerUnit < 0).length;

  // Color the total margin
  const margeEl = document.getElementById('mg-total-marge');
  margeEl.style.color = totalMarge >= 0 ? 'var(--green)' : 'var(--red)';

  renderMatchTable();
  toast('Margenanalyse fertig: ' + fmt(totalMarge) + ' € Marge');
}

function renderMatchTable() {
  const wrap = document.getElementById('match-table-wrap');
  if (!matchData.length) return;

  const filter = document.getElementById('filter-match').value;
  const q = (document.getElementById('search-match').value || '').toLowerCase();

  let filtered = matchData;
  if (filter === 'found') filtered = filtered.filter(r => r.status !== 'missing');
  else if (filter === 'missing') filtered = filtered.filter(r => r.status === 'missing');
  else if (filter === 'diff') filtered = filtered.filter(r => r.css && !r.preisMatch);
  else if (filter === 'negative') filtered = filtered.filter(r => r.margePerUnit < 0);
  else if (filter === 'high') filtered = filtered.filter(r => r.margePct > 50);
  else if (filter === 'low') filtered = filtered.filter(r => r.css && r.margePct >= 0 && r.margePct < 20);

  if (q) filtered = filtered.filter(r =>
    r.ref.toLowerCase().includes(q) || r.beschreibung.toLowerCase().includes(q) || r.postRef.toLowerCase().includes(q)
  );

  document.getElementById('count-match-tbl').textContent = filtered.length + ' / ' + matchData.length;

  // Sort: negative margin first, then by margin %
  filtered.sort((a, b) => a.margePct - b.margePct);

  var hasCssLive = matchData.some(function(r) { return r.cssNr; });
  var cssLiveHead = hasCssLive ? '<th>CSS-Nr</th><th class="text-right">CSS EK Live</th><th class="text-right">Bestand</th><th>Verfügbar</th>' : '';

  wrap.innerHTML = '<table>'
    + '<thead><tr>'
    + '<th>Status</th><th>REF</th><th>Beschreibung</th><th class="text-center">Menge</th>'
    + '<th class="text-right">Best.-Preis</th><th class="text-right">CSS KD-Preis</th><th class="text-right">Preis-Diff</th>'
    + '<th class="text-right">Dein EK</th>'
    + '<th class="text-right">Marge/Stk</th><th class="text-right">Marge %</th>'
    + '<th class="text-right">VK Gesamt</th><th class="text-right">EK Gesamt</th>'
    + '<th class="text-right">Marge Gesamt</th>'
    + cssLiveHead
    + '<th>CSS Bez.</th>'
    + '</tr></thead><tbody>'
    + filtered.map(function(r) {
      var badge, label;
      if (r.status === 'missing') { badge = 'badge-red'; label = 'FEHLT'; }
      else if (r.margePerUnit < 0) { badge = 'badge-red'; label = 'VERLUST'; }
      else if (r.margePct < 10) { badge = 'badge-orange'; label = 'GERING'; }
      else if (r.margePct >= 50) { badge = 'badge-purple'; label = 'HOCH'; }
      else { badge = 'badge-green'; label = 'OK'; }

      var margeColor = r.margePerUnit > 0.01 ? 'var(--green)' : r.margePerUnit < -0.01 ? 'var(--red)' : 'var(--text2)';
      var rowStyle = r.margePerUnit < 0 ? ' style="background:rgba(248,113,113,.08)"' : '';

      var preisDiffColor = r.css ? (r.preisMatch ? 'var(--green)' : 'var(--orange)') : 'var(--text2)';
      var preisDiff = r.css ? r.preis - r.cssKdPreis : 0;
      var preisDiffStr = r.css ? (r.preisMatch ? 'OK' : (preisDiff > 0 ? '+' : '') + fmt(preisDiff)) : '—';

      var row = '<tr' + rowStyle + '>'
        + '<td><span class="badge ' + badge + '">' + label + '</span></td>'
        + '<td class="mono">' + r.ref + '</td>'
        + '<td>' + r.beschreibung + '</td>'
        + '<td class="text-center">' + r.menge + '</td>'
        + '<td class="text-right mono">' + fmt(r.preis) + '</td>'
        + '<td class="text-right mono">' + (r.css ? fmt(r.cssKdPreis) : '—') + '</td>'
        + '<td class="text-right mono" style="color:' + preisDiffColor + ';font-weight:600">' + preisDiffStr + '</td>'
        + '<td class="text-right mono">' + (r.css ? fmt(r.ekPerUnit) : '—') + '</td>'
        + '<td class="text-right mono" style="color:' + margeColor + '">' + (r.css ? fmt(r.margePerUnit) : '—') + '</td>'
        + '<td class="text-right mono" style="color:' + margeColor + '">' + (r.css ? fmt(r.margePct) + '%' : '—') + '</td>'
        + '<td class="text-right mono">' + fmt(r.gesamt) + '</td>'
        + '<td class="text-right mono">' + (r.css ? fmt(r.ekGesamt) : '—') + '</td>'
        + '<td class="text-right mono" style="color:' + margeColor + ';font-weight:600">' + (r.css ? fmt(r.margeGesamt) : '—') + '</td>';
      if (hasCssLive) {
        var verfMap = { verfuegbar: 'Ja', nichtverfuegbar: 'Nein', unbekannt: '?', teilvefuergbar: 'Teilw.', nichtmehrlieferbar: 'N.m.l.', nochnichtangefragt: '-' };
        var verfColor = r.cssVerfuegbar === 'verfuegbar' ? 'var(--green)' : r.cssVerfuegbar === 'nichtverfuegbar' || r.cssVerfuegbar === 'nichtmehrlieferbar' ? 'var(--red)' : 'var(--text2)';
        row += '<td class="mono">' + (r.cssNr || '—') + '</td>'
          + '<td class="text-right mono">' + (r.cssEkLive ? fmt(r.cssEkLive) : '—') + '</td>'
          + '<td class="text-right mono">' + (r.cssBestand !== undefined ? r.cssBestand : '—') + '</td>'
          + '<td style="color:' + verfColor + '">' + (verfMap[r.cssVerfuegbar] || r.cssVerfuegbar || '—') + '</td>';
      }
      row += '<td>' + (r.css ? r.css.description : '—') + '</td>'
        + '</tr>';
      return row;
    }).join('')
    + '</tbody></table>';
}

// ── EXCEL EXPORT Margenanalyse ──
function exportAbgleichExcel(filter) {
  if (!matchData.length) { toast('Erst Margenanalyse starten'); return; }

  var items = matchData;
  var suffix = 'Komplett';
  if (filter === 'diff') { items = items.filter(function(r) { return r.css && !r.preisMatch; }); suffix = 'Preisabweichungen'; }
  else if (filter === 'negative') { items = items.filter(function(r) { return r.margePerUnit < 0; }); suffix = 'Verluste'; }
  else if (filter === 'missing') { items = items.filter(function(r) { return r.status === 'missing'; }); suffix = 'Nicht_in_CSS'; }

  if (!items.length) { toast('Keine Einträge für diesen Filter'); return; }

  var rows = items.map(function(r) {
    return {
      'POST REF': r.postRef,
      'REF (Teilenr)': r.ref,
      'Beschreibung': r.beschreibung,
      'Menge': r.menge,
      'Best.-Preis/Stk': r.preis,
      'CSS KD-Preis': r.cssKdPreis || '',
      'Preis-Diff': r.css ? Math.round((r.preis - r.cssKdPreis) * 100) / 100 : '',
      'Preis OK': r.css ? (r.preisMatch ? 'JA' : 'NEIN') : '',
      'Dein EK/Stk': r.ekPerUnit || '',
      'Marge/Stk': r.css ? r.margePerUnit : '',
      'Marge %': r.css ? Math.round(r.margePct * 100) / 100 : '',
      'VK Gesamt': r.gesamt,
      'EK Gesamt': r.ekGesamt || '',
      'Marge Gesamt': r.css ? r.margeGesamt : '',
      'Status': r.status === 'missing' ? 'FEHLT' : r.margePerUnit < 0 ? 'VERLUST' : 'OK',
      'CSS-Nr (WaWi)': r.cssNr || '',
      'CSS EK Live': r.cssEkLive || '',
      'Bestand': r.cssBestand !== undefined ? r.cssBestand : '',
      'Verfügbar': r.cssVerfuegbar || '',
      'CSS Bezeichnung': r.css ? r.css.description : ''
    };
  });

  // Add summary row
  var totalVK = items.reduce(function(s, r) { return s + (r.gesamt || 0); }, 0);
  var totalEK = items.reduce(function(s, r) { return s + (r.ekGesamt || 0); }, 0);
  var totalMarge = totalVK - totalEK;
  rows.push({
    'POST REF': '',
    'REF (Teilenr)': '',
    'Beschreibung': 'SUMME',
    'Menge': items.reduce(function(s, r) { return s + r.menge; }, 0),
    'VK/Stk (Kundenpreis)': '',
    'EK/Stk (CSS)': '',
    'Marge/Stk': '',
    'Marge %': totalVK > 0 ? Math.round((totalMarge / totalVK) * 10000) / 100 : '',
    'VK Gesamt': totalVK,
    'EK Gesamt': totalEK,
    'Marge Gesamt': totalMarge,
    'Status': '',
    'CSS Bezeichnung': ''
  });

  var ws = XLSX.utils.json_to_sheet(rows);
  ws['!cols'] = [
    {wch:14},{wch:14},{wch:40},{wch:8},{wch:14},{wch:14},
    {wch:12},{wch:10},{wch:14},{wch:14},{wch:14},{wch:10},{wch:30}
  ];
  var wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Margenanalyse');
  XLSX.writeFile(wb, 'Margenanalyse_' + suffix + '.xlsx');
  toast('Excel Export: ' + suffix);
}

// ── CSS WARENWIRTSCHAFT ABFRAGE (SOAP) ──
var CSS_ENDPOINT = 'http://80.153.160.204:8080/dvse/Erp.asmx';
var CSS_CUSTOMER_ID = '1344';
var CSS_CUSTOMER_ID2 = '866';
var CSS_DLNR = '7455';
var CSS_BATCH_SIZE = 30;
var CSS_PROXY_PATH = '/api/css-proxy'; // Vercel serverless proxy

function buildCssSoapRequest(articles) {
  var itemsXml = articles.map(function(ref) {
    return '<Item>'
      + '<EinspNr>' + CSS_DLNR + '</EinspNr>'
      + '<EinspArtNr>' + ref + '</EinspArtNr>'
      + '<GenericPartNr>0</GenericPartNr>'
      + '<TecdocTypeNr>0</TecdocTypeNr>'
      + '<Type>0</Type>'
      + '<AvailState>nochnichtangefragt</AvailState>'
      + '<RequestedQuantity><Value>1</Value></RequestedQuantity>'
      + '</Item>';
  }).join('');

  return '<?xml version="1.0" encoding="utf-8"?>'
    + '<soap12:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap12="http://www.w3.org/2003/05/soap-envelope">'
    + '<soap12:Body>'
    + '<GetArticleInformation xmlns="DVSE.WebApp.ErpService">'
    + '<user><CustomerId>' + CSS_CUSTOMER_ID + '</CustomerId><CustomerId2>' + CSS_CUSTOMER_ID2 + '</CustomerId2><UserName></UserName><PassWord></PassWord></user>'
    + '<items><Item>' + itemsXml + '</Item></items>'
    + '</GetArticleInformation>'
    + '</soap12:Body></soap12:Envelope>';
}

function parseCssResponse(xmlText) {
  var parser = new DOMParser();
  var doc = parser.parseFromString(xmlText, 'text/xml');
  var ns = 'DVSE.WebApp.ErpService';
  var results = {};

  // Get all Item elements from response
  var items = doc.getElementsByTagNameNS(ns, 'Item');
  for (var i = 0; i < items.length; i++) {
    var item = items[i];
    var artNr = item.getElementsByTagNameNS(ns, 'ArtikelNummer');
    var einspArtNr = item.getElementsByTagNameNS(ns, 'EinspArtNr');
    var availState = item.getElementsByTagNameNS(ns, 'AvailState');

    if (!einspArtNr.length) continue;
    var ref = einspArtNr[0].textContent.trim().toUpperCase();

    var cssNr = artNr.length ? artNr[0].textContent.trim() : '';
    var avail = availState.length ? availState[0].textContent.trim() : '';

    // Parse prices
    var ekPreis = 0, vkPreis = 0;
    var prices = item.getElementsByTagNameNS(ns, 'Price');
    for (var p = 0; p < prices.length; p++) {
      var priceCode = prices[p].getElementsByTagNameNS(ns, 'PriceCode');
      var priceValue = prices[p].getElementsByTagNameNS(ns, 'Value');
      if (priceCode.length && priceValue.length) {
        var code = priceCode[0].textContent.trim();
        var val = parseFloat(priceValue[0].textContent) || 0;
        if (code === '4') ekPreis = val;  // EK per Stück
        if (code === '5') vkPreis = val;  // VK per Stück
      }
    }

    // Parse quantity (stock)
    var bestand = 0;
    var quantities = item.getElementsByTagNameNS(ns, 'Quantity');
    for (var q = 0; q < quantities.length; q++) {
      // Skip RequestedQuantity
      if (quantities[q].parentElement && quantities[q].parentElement.localName === 'Quantity') {
        var qVal = quantities[q].getElementsByTagNameNS(ns, 'Value');
        if (qVal.length) bestand = parseFloat(qVal[0].textContent) || 0;
      }
    }

    results[ref] = {
      cssNr: cssNr,
      cssEk: ekPreis,
      cssVk: vkPreis,
      cssBestand: bestand,
      cssVerfuegbar: avail
    };
  }
  return results;
}

var cssQueryRunning = false;

async function startCssQuery() {
  if (cssQueryRunning) { toast('Abfrage läuft bereits...'); return; }
  if (!matchData.length) { toast('Erst Margenanalyse starten'); return; }

  cssQueryRunning = true;
  var btn = document.getElementById('btn-css-query');
  var statusEl = document.getElementById('css-query-status');
  btn.disabled = true;
  btn.textContent = 'Abfrage läuft...';

  // Collect all unique REFs from matchData
  var allRefs = matchData.map(function(r) { return r.ref; }).filter(function(r) { return r; });
  var batches = [];
  for (var i = 0; i < allRefs.length; i += CSS_BATCH_SIZE) {
    batches.push(allRefs.slice(i, i + CSS_BATCH_SIZE));
  }

  var totalResults = {};
  var errors = 0;

  for (var b = 0; b < batches.length; b++) {
    statusEl.textContent = 'Batch ' + (b + 1) + ' / ' + batches.length + ' (' + batches[b].length + ' Artikel)...';

    try {
      var soapBody = buildCssSoapRequest(batches[b]);
      // Use own proxy (Vercel) or direct (if same origin)
      var proxyUrl = window.location.hostname.includes('vercel') || window.location.hostname.includes('localhost')
        ? CSS_PROXY_PATH
        : CSS_PROXY_PATH;
      var response = await fetch(proxyUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/xml; charset=utf-8' },
        body: soapBody
      });

      if (!response.ok) throw new Error('HTTP ' + response.status);
      var xmlText = await response.text();
      var batchResults = parseCssResponse(xmlText);
      Object.assign(totalResults, batchResults);
    } catch (err) {
      console.error('CSS Batch ' + (b + 1) + ' Fehler:', err);
      errors++;
    }

    // Small delay between batches
    if (b < batches.length - 1) {
      await new Promise(function(r) { setTimeout(r, 500); });
    }
  }

  // Enrich matchData with CSS results
  matchData.forEach(function(r) {
    var cssResult = totalResults[r.ref];
    if (cssResult) {
      r.cssNr = cssResult.cssNr;
      r.cssEkLive = cssResult.cssEk;
      r.cssVkLive = cssResult.cssVk;
      r.cssBestand = cssResult.cssBestand;
      r.cssVerfuegbar = cssResult.cssVerfuegbar;
    }
  });

  cssQueryRunning = false;
  btn.disabled = false;
  btn.textContent = 'CSS Warenwirtschaft abfragen';
  var found = Object.keys(totalResults).length;
  statusEl.textContent = found + ' Artikel gefunden' + (errors ? ', ' + errors + ' Fehler' : '');

  renderMatchTable();
  toast('CSS Abfrage fertig: ' + found + ' Artikel');
}

function downloadCssExport() {
  if (!cssData.length) { toast('Keine CSS Daten'); return; }
  const header = 'article;list_price;buying_price;buying_price_self;discount;discount_self;description;weight;DLNR\n';
  const rows = cssData.map(r =>
    [r.article, fmtP(r.listPrice), fmtP(r.buyingPrice), fmtP(r.buyingPriceSelf),
     fmtP(r.discount), fmtP(r.discountSelf), r.description, r.weight, r.dlnr].join(';')
  ).join('\n');
  downloadFile('css-export.csv', header + rows);
  toast('CSS Export heruntergeladen');
}

function downloadFile(name, content) {
  const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
}
</script>
</body>
</html>
